= Microservices : un √©tat des lieux
Thomas SCHWENDER <https://github.com/ardemius[@ardemius]>
// Handling GitHub admonition blocks icons
ifndef::env-github[:icons: font]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]
:imagesdir: ./images
:source-highlighter: highlightjs
// Next 2 ones are to handle line breaks in some particular elements (list, footnotes, etc.)
:lb: pass:[<br> +]
:sb: pass:[<br>]
// check https://github.com/Ardemius/personal-wiki/wiki/AsciiDoctor-tips for tips on table of content in GitHub
:toc: macro
:toclevels: 1
// To turn off figure caption labels and numbers
:figure-caption!:

toc::[]

== Microservices : un rien d'histoire et quelques d√©finitions

On peut voir l‚Äô*architecture microservices* comme une √©volution l‚Äôarchitecture *SOA* (Service Oriented Architecture), elle-m√™me cr√©√©e pour pallier aux inconv√©nients des *applications monolithiques*.

image:microservices-etat-des-lieux_01.jpg[]

* Un des points int√©ressants √† remarquer dans la transition SOA vers l‚Äôarchitecture microservices, est la *suppression de l‚ÄôESB* (Enterprise Service Bus). +
La communication entre les services devait √™tre la principale fonction de ce composant, mais il embarquait fr√©quemment une *trop grande complexit√© m√©tier*. +
Pour corriger cela, il a √©t√© *remplac√© par les endpoints REST des microservices*. +
Pour illustrer ce changement, Martin Fowler palera de _"Smart endpoints and Dumb pipes"_

* On constate √©galement que l'on ne travaille plus avec un seul et unique runtime, mais avec *1 runtime par microservice*, ce qui participe √† garantir une de leurs principales caract√©ristiques :  l'*isolation*.

== L'inspiration des microservices

En 2005, Alistair Cockburn pr√©sentait l‚Äô*architecture hexagonale* (ou mod√®le *‚ÄúPorts and Adapters‚Äù*) afin de permettre la conception d‚Äôapplications pouvant √™tre test√©es en *isolation de leurs runtimes et bases de donn√©es*.

Cela a √©t√© l‚Äôinspiration pour l‚Äôarchitecture microservices, dont Alistair donna ensuite la d√©finition suivante : _‚ÄúAn architectural style or an approach for building IT systems as a set of business capabilities that are autonomous, self contained, and loosely coupled‚Äù_

== Architecture hexagonale

image::microservices-etat-des-lieux_02.jpg[]

IMPORTANT: Le principe fondateur de ce pattern est que [red]*le m√©tier ne doit d√©pendre de rien* : TOUTES les d√©pendances vont de *l‚Äôext√©rieur vers l‚Äôint√©rieur*.

Le but principal de cette architecture ne date pas d'hier, il est question de *s√©parer clairement le m√©tier de l'impl√©mentation technique* (notion d'*isolation*).

* Tout ce qui se trouve √† [red]*gauche de l'hexagone* repr√©sente [red]*les composants qui ont besoin de ce dernier*. +
On trouve c√¥t√© gauche des *interfaces expos√©es pour les composants ayant besoin d'invoquer le mod√®le*. On parle d'*API*, pour _Application Provider Interfaces_. +
-> Les composants souhaitant communiquer avec notre m√©tier le feront au travers d‚Äô*adaptateurs qui contacteront nos API*.

* Tout ce qui se trouve √† [red]*droite de l'hexagone* repr√©sente [red]*les composants dont ce dernier a besoin*. +
On trouve c√¥t√© droit des *interfaces expos√©es pour les composants que le mod√®le a besoin d‚Äôinvoquer*. On parle de *SPI*, pour _Service Provider Interfaces_. +
-> Les composants avec lesquels notre m√©tier souhaite communiquer seront contact√©s au travers des *SPI dont les impl√©mentations seront r√©solues √† l‚Äôex√©cution et fournies par des adaptateurs*.

== Isolation

image::microservices-etat-des-lieux_03.jpg[]

Comme nous le verrons plus en d√©tail par la suite, la notion d'*isolation* est capitale pour les microservices, or *l'isolation am√®ne la redondance*, et cette derni√®re, on nous a appris √† la "combattre" depuis des dizaines d'ann√©es. +
Rappelez-vous le principe introduit dans https://www.amazon.fr/Pragmatic-Programmer-Journeyman-Master/dp/020161622X[_The Pragmatic Programmer_] : *Don't Repeat Yourself (DRY)*.

Prenons le cas de 2 classes partageant un m√™me comportement. +
Comme on nous l'a appris en programmation OO, on aura g√©n√©ralement tendance √† sortir ce comportement commun dans une classe de plus haut niveau, qui sera ensuite h√©rit√©e. +
Si on change le comportement de la classe m√®re, on impacte donc les 2 classes filles. +
Cet h√©ritage a donc augment√© le couplage entre nos classes.

[NOTE]
====
L'exemple pr√©c√©dent est... juste un exemple pour illustrer un probl√®me classique de couplage üòÖ +
On pourrait faire diff√©remment, en utilisant la composition ou d'autres patterns (ne me tappez pas... üòâ)
====

Dans le cas des microservices, nous voulons √©viter un maximum tout couplage, afin que ces derniers soient le plus *ind√©pendants* possible.
Donc, entre *DRY et couplage*, et [red]*isolution et redondance*, la 2nd approche est privil√©gi√©e.

.DDD et redondance
[NOTE]
====
La conception des microservices pl√©biscite l'approche *DDD* (*Domain Driven Design*). +
Cette approche, tout particuli√®rement le d√©coupage en *bounded context*, nous encourage tr√®s fortement √† limiter le couplage, quitte √† "se r√©p√©ter" par moment. +
Ce qui fait pencher encore un peu plus la balance vers "l'isolation et redondance".

Si vous voulez plus de d√©tails sur ce point, je vous conseille l'excellente conf√©rence https://www.youtube.com/watch?v=xZOO_CksS-E[Hexagonal at Scale, with DDD and microservices!] de Cyrille Martraire, lors du Voxxed Days Microservices Paris 2018.
====
